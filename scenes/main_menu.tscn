[gd_scene load_steps=10 format=3 uid="uid://cgaqfbqdfpmgw"]

[ext_resource type="Shader" uid="uid://br6q47lbt6ynk" path="res://shaders/main_menu.gdshader" id="1_l6cm7"]
[ext_resource type="Script" uid="uid://df6epjbxqbxbr" path="res://scenes/main_menu.gd" id="1_wu84c"]
[ext_resource type="PackedScene" uid="uid://cyjnmwjaxnqx5" path="res://scenes/ui/level_selection.tscn" id="2_8ln24"]
[ext_resource type="Shader" uid="uid://bwe8dyxx3mvov" path="res://shaders/vignette.gdshader" id="2_ekxnf"]
[ext_resource type="Theme" uid="uid://dqkoqj84qg1dt" path="res://themes/default.tres" id="3_bqqt6"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_vue75"]
shader = ExtResource("1_l6cm7")
shader_parameter/bottom_color = Color(0.18431373, 0.16470589, 0.20784314, 1)
shader_parameter/top_color = Color(0.23137255, 0.25882354, 0.38431373, 1)
shader_parameter/wave_amp = 0.3970000188575
shader_parameter/wave_size = 1.8850000420375
shader_parameter/wave_time_mul = 0.19300000590762
shader_parameter/total_phases = 10

[sub_resource type="ShaderMaterial" id="ShaderMaterial_bqqt6"]
shader = ExtResource("2_ekxnf")
shader_parameter/radius = 0.800000038
shader_parameter/softness = 0.2990000142025
shader_parameter/intensity = 0.7590000360525
shader_parameter/contrast = 2.2
shader_parameter/vignette_color = Color(0, 0, 0, 1)

[sub_resource type="Shader" id="Shader_ekxnf"]
code = "shader_type canvas_item;
render_mode unshaded;

uniform vec4 drop_shadow_color : source_color = vec4(0.0, 0.0, 0.0, 0.5);
uniform float shadow_offset_x : hint_range(-0.3, 0.3) = 0.05;
uniform float shadow_offset_y : hint_range(-0.3, 0.3) = 0.05;
uniform float shadow_rotation : hint_range(0.0, 360.0) = 0.0;
uniform vec2 rotation_pivot = vec2(0.5, 0.5);

uniform float shadow_blur_strength : hint_range(0.0, 20.0) = 2.0;
uniform int shadow_blur_samples : hint_range(3, 8, 1) = 4;
uniform float _blur_scale_factor = 1.0;

uniform sampler2D SCREEN_TEXTURE : hint_screen_texture, repeat_disable, filter_linear_mipmap;

vec2 rotate_uv(vec2 uv, float angle, vec2 aspect_correction) {
    uv -= rotation_pivot;
    uv *= aspect_correction; // Correct aspect ratio before rotation
    float s = sin(angle);
    float c = cos(angle);
    vec2 rotated = vec2(
        uv.x * c - uv.y * s,
        uv.x * s + uv.y * c
    );
    rotated /= aspect_correction; // Restore original proportions
    return rotated + rotation_pivot;
}

vec4 get_rotated_shadow(vec2 uv, float rotation, vec2 aspect) {
    vec2 corrected_uv = rotate_uv(uv, rotation, aspect);
    return texture(SCREEN_TEXTURE, corrected_uv);
}

vec4 apply_shadow_blur(vec2 uv, vec2 pixel_size, vec2 offset, float rotation, vec2 aspect) {
    float samples = float(pow(2.0, float(shadow_blur_samples)));
	float scaled_blur_strength = shadow_blur_strength * _blur_scale_factor;
    float layer_increment = scaled_blur_strength / samples;
    float angle_increment = TAU / samples;

    // Base rotated shadow
    vec4 shadow_base = get_rotated_shadow(uv - offset, rotation, aspect);
    vec4 color = vec4(drop_shadow_color.rgb, drop_shadow_color.a * shadow_base.a);

    if (scaled_blur_strength <= 0.0) return color;

    // Blur with aspect-corrected rotation
    for (float d = layer_increment; d <= scaled_blur_strength; d += layer_increment) {
        vec4 layer_color = vec4(0.0);
        for (float t = 0.0; t < TAU; t += angle_increment) {
            vec2 sample_uv = uv - offset + vec2(cos(t), sin(t)) * d * pixel_size;
            vec4 sample = get_rotated_shadow(sample_uv, rotation, aspect);
            layer_color += vec4(drop_shadow_color.rgb, drop_shadow_color.a * sample.a);
        }
        layer_color /= samples;
        float weight = 1.0 - sqrt(d / scaled_blur_strength);
        color = mix(color, layer_color, weight);
    }

    return color;
}

void fragment() {
    vec2 pixel_size = SCREEN_PIXEL_SIZE;
    vec2 uv = SCREEN_UV;
    float rotation = radians(shadow_rotation);
    vec2 offset = vec2(shadow_offset_x, shadow_offset_y);
    
    // Calculate aspect ratio correction (width/height, height/width)
    vec2 aspect = vec2(1.0, SCREEN_PIXEL_SIZE.x/SCREEN_PIXEL_SIZE.y);

    vec4 original = texture(SCREEN_TEXTURE, uv);
    vec4 shadow = apply_shadow_blur(uv, pixel_size, offset, rotation, aspect);

    COLOR = mix(shadow, original, original.a);
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_wu84c"]
shader = SubResource("Shader_ekxnf")
shader_parameter/drop_shadow_color = Color(0, 0, 0, 0.5)
shader_parameter/shadow_offset_x = 0.00500000256657001
shader_parameter/shadow_offset_y = 0.01000000280406998
shader_parameter/shadow_rotation = 0.0
shader_parameter/rotation_pivot = Vector2(0.5, 0.5)
shader_parameter/shadow_blur_strength = 2.0
shader_parameter/shadow_blur_samples = 4
shader_parameter/_blur_scale_factor = 1.0

[node name="main_menu" type="CanvasLayer" node_paths=PackedStringArray("title", "play")]
layer = 3
script = ExtResource("1_wu84c")
title = NodePath("Control/CanvasGroup/VBoxContainer/title")
play = NodePath("Control/CanvasGroup/VBoxContainer/play")
level_selection = ExtResource("2_8ln24")

[node name="Control" type="Control" parent="."]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="ColorRect" type="ColorRect" parent="Control"]
material = SubResource("ShaderMaterial_vue75")
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="vignette" type="ColorRect" parent="Control"]
material = SubResource("ShaderMaterial_bqqt6")
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="CanvasGroup" type="CanvasGroup" parent="Control"]
material = SubResource("ShaderMaterial_wu84c")

[node name="VBoxContainer" type="VBoxContainer" parent="Control/CanvasGroup"]
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = 341.5
offset_top = 238.0
offset_right = 810.5
offset_bottom = 410.0
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/separation = 30

[node name="title" type="Label" parent="Control/CanvasGroup/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 84
text = "FLOOD ESCAPE"

[node name="play" type="Button" parent="Control/CanvasGroup/VBoxContainer"]
layout_mode = 2
size_flags_horizontal = 4
size_flags_vertical = 4
theme = ExtResource("3_bqqt6")
theme_override_font_sizes/font_size = 48
text = "PLAY"

[connection signal="mouse_entered" from="Control/CanvasGroup/VBoxContainer/play" to="." method="_on_play_mouse_entered"]
[connection signal="mouse_exited" from="Control/CanvasGroup/VBoxContainer/play" to="." method="_on_play_mouse_exited"]
[connection signal="pressed" from="Control/CanvasGroup/VBoxContainer/play" to="." method="_on_play_pressed"]
